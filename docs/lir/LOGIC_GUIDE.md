# Logic Guide - Funding Intelligence System

This guide documents the key logic modules and features in the codebase. Each section explains how important logic works without requiring code deep-dives.

---

## DataExtractionAgent V2 - Modular Architecture

**Description**: Main orchestrator for API data collection, field mapping, and taxonomy standardization. Replaces monolithic V1 agent with modular components.

**How It Works**:
- Takes source + processingInstructions from SourceOrchestrator
- Routes to appropriate API workflow (single_api vs two_step_api)
- Stores raw API responses with deduplication
- Extracts opportunities using AI-powered schema processing
- Returns standardized opportunities with tracking metadata

**Design Notes**:
- Uses centralized Anthropic client with proper schemas
- Raw response storage enables debugging and reprocessing
- Modular folder structure: apiHandlers/, extraction/, storage/, utils/
- Two-stage filtering system for relevance then detailed processing

---

## API Parameter Handling - Pagination vs Manual Configuration

**Description**: System for handling API parameters, with automatic pagination parameter injection and manual parameter configuration.

**How It Works**:
- Manual parameters loaded first: `params = {...queryParameters}`
- Pagination parameters added second: `params[limitParam] = pageSize`
- **Pagination always overwrites manual parameters with same names**
- Location controlled by `inBody` flag: query params (false) vs request body (true)
- Same overwrite logic applies to request body parameters

**Design Notes**:
- **Critical**: If pagination enabled, don't manually add same parameter names (limit, offset, page)
- Users should choose either pagination OR manual parameter configuration, not both
- Pagination handles limits automatically; manual config used for non-paginated APIs

---

## Pagination Logic - Result Limiting

**Description**: How the system calculates and enforces result limits across paginated API calls.

**How It Works**:
- **With pagination enabled**: Total limit = `maxPages × pageSize`
- **Without pagination**: User adds manual `limit` in query params or request body
- System adjusts final page size to not exceed total limit
- Stops pagination early when limit reached or no more data available
- **No global limit parameter needed** - existing controls handle all scenarios

**Design Notes**:
- Pagination provides natural limiting through maxPages × pageSize calculation
- Manual limits work for non-paginated APIs through query/body parameters
- Early termination prevents unnecessary API calls when limits reached

---

## Two-Step API Workflow

**Description**: Handles APIs that require two calls: first to get a list of items, then detail calls for each item.

**How It Works**:
- Step 1: Use single API handler to get list of opportunities
- Step 2: Extract IDs using `detailConfig.idField` from list results
- Step 3: Make parallel detail API calls using `detailConfig.endpoint`
- Combines list metadata with detailed information for final results

**Design Notes**:
- Common pattern for APIs like Grants.gov (search → detail)
- Detail calls are batched and parallelized for performance
- Uses same pagination logic for the initial list call
- Falls back gracefully if detail calls fail

---

## SourceOrchestrator V2 - Configuration-Based Analysis

**Description**: Replaces AI-powered source analysis with direct configuration mapping from database.

**How It Works**:
- Takes source object with pre-configured database settings
- Maps database configurations to processing instructions
- Determines workflow type based on `detail_config.enabled`
- Returns complete processingInstructions object for DataExtractionAgent
- **No AI analysis needed** - pure configuration transformation

**Design Notes**:
- Much faster than V1 (no LLM calls for source analysis)
- Relies on accurate database configuration from admin interface
- Input validation ensures required fields (name, api_endpoint) present
- Maintains same output format as V1 for backward compatibility

---

## Processing Instructions Schema

**Description**: Standardized configuration object that flows between agents in the V2 pipeline.

**How It Works**:
- Contains all API call configuration: endpoints, auth, pagination, etc.
- Generated by SourceOrchestrator, consumed by DataExtractionAgent
- Key sections: workflow, requestConfig, paginationConfig, detailConfig, responseMapping
- Used to build actual HTTP requests with proper parameters and headers

**Design Notes**:
- Single source of truth for how to process each API source
- Eliminates need for agents to interpret raw database configurations
- Enables consistent API call patterns across different workflow types
- Well-documented structure prevents integration issues between agents

---

**Note**: When adding new modules or logic blocks to the codebase, update this guide with a new section following the same format structure. 